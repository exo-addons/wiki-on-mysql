<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.3.xsd">

    <!-- Managing both DB that use sequences and db that use auto increment -->
    <property name="autoIncrement" value="true" dbms="mysql,mssql,h2,sybase,db2,hsqldb"/>
    <property name="autoIncrement" value="false" dbms="oracle,postgresql"/>

    <!-- Managing auto generation of timestamp by Database -->
    <property name="now" value="now()" dbms="mysql,hsqldb,postgresql,h2"/>
    <property name="now" value="sysdate" dbms="oracle"/>
    <property name="now" value="CURRENT_TIMESTAMP" dbms="mssql"/>


    <changeSet author="wiki-rdbms" id="1.0.0-1">
        <createTable tableName="WIKI_WIKIS">
            <column name="WIKI_ID" type="BIGINT" autoIncrement="${autoIncrement}" startWith="1">
                <constraints nullable="false" primaryKey="true" primaryKeyName="PK_WIKI_WIKIS_WIKI_ID"/>
            </column>
            <column name="NAME" type="VARCHAR(50)"/>
            <column name="OWNER" type="VARCHAR(36)">
                <constraints nullable="true"/>
            </column>
            <column name="TYPE" type="VARCHAR(50)"/>
            <column name="WIKI_HOME" type="BIGINT"/>
        </createTable>
    </changeSet>

    <changeSet author="wiki-rdbms" id="1.0.0-2">
        <createTable tableName="WIKI_PAGES">
            <column name="PAGE_ID" type="BIGINT" autoIncrement="${autoIncrement}" startWith="1">
                <constraints nullable="false" primaryKey="true" primaryKeyName="PK_WIKI_PAGES_PAGE_ID"/>
            </column>
            <column name="WIKI_ID" type="BIGINT"/>
            <column name="PARENT_PAGE_ID" type="BIGINT"/>
            <column name="AUTHOR" type="VARCHAR(36)"/>
            <column name="NAME" type="VARCHAR(50)"/>
            <column name="OWNER" type="VARCHAR(36)"/>
            <column name="CREATED_DATE" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="UPDATED_DATE" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="CONTENT" type="TEXT(5000)"/>
            <column name="SYNTAX" type="TEXT(5000)"/>
            <column name="TITLE" type="VARCHAR(250)"/>
            <column name="COMMENT" type="VARCHAR(2000)"/>
            <column name="URL" type="VARCHAR(500)"/>
            <column name="IS_MINOR_EDIT" type="CHAR(1)"/>
            <column name="ACTIVITY_ID" type="VARCHAR(36)"/>
        </createTable>
    </changeSet>

    <changeSet author="wiki-rdbms" id="1.0.0-3">
        <createTable tableName="WIKI_ATTACHMENTS">
            <column name="ATTACHMENT_ID" type="BIGINT" autoIncrement="${autoIncrement}" startWith="1">
                <constraints nullable="false" primaryKey="true" primaryKeyName="PK_WIKI_ATTACHMENTS_ATTACHMENT_ID"/>
            </column>
            <column name="NAME" type="VARCHAR(50)"/>
            <column name="CREATOR" type="VARCHAR(36)">
                <constraints nullable="true"/>
            </column>
            <column name="CREATED_DATE" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="UPDATED_DATE" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="DOWNLOAD_URL" type="VARCHAR(500)"/>
            <column name="TITLE" type="VARCHAR(250)"/>
            <column name="CONTENT" type="BLOB"/>
            <column name="PAGE_ID" type="BIGINT"/>
        </createTable>
    </changeSet>

    <changeSet author="wiki-rdbms" id="1.0.0-4">
        <createTable tableName="WIKI_WATCHERS">
            <column name="WATCHER_ID" type="BIGINT" autoIncrement="${autoIncrement}" startWith="1">
                <constraints nullable="false" primaryKey="true" primaryKeyName="PK_WIKI_WATCHERS_WATCHER_ID"/>
            </column>
            <column name="USERNAME" type="VARCHAR(36)"/>
            <column name="PAGE_ID" type="BIGINT"/>
        </createTable>
    </changeSet>

    <changeSet author="wiki-rdbms" id="1.0.0-5">
        <createTable tableName="WIKI_EMOTION_ICONS">
            <column name="EMOTION_ICON_ID" type="BIGINT" autoIncrement="${autoIncrement}" startWith="1">
                <constraints nullable="false" primaryKey="true" primaryKeyName="PK_WIKI_EMOTION_ICONS_EMOTION_ICON_ID"/>
            </column>
            <column name="NAME" type="VARCHAR(50)"/>
            <column name="IMAGE" type="BLOB"/>
        </createTable>
    </changeSet>

    <changeSet author="wiki-rdbms" id="1.0.0-6">
        <createTable tableName="WIKI_TEMPLATES">
            <column name="TEMPLATE_ID" type="BIGINT" autoIncrement="${autoIncrement}" startWith="1">
                <constraints nullable="false" primaryKey="true" primaryKeyName="PK_WIKI_TEMPLATES_TEMPLATE_ID"/>
            </column>
            <column name="WIKI_ID" type="BIGINT"/>
            <column name="NAME" type="VARCHAR(50)"/>
            <column name="CONTENT" type="TEXT(5000)"/>
            <column name="SYNTAX" type="TEXT(5000)"/>
            <column name="TITLE" type="VARCHAR(250)"/>
        </createTable>
    </changeSet>

    <changeSet author="wiki-rdbms" id="1.0.0-7">
        <createTable tableName="WIKI_DRAFT_PAGES">
            <column name="DRAFT_PAGE_ID" type="BIGINT" autoIncrement="${autoIncrement}" startWith="1">
                <constraints nullable="false" primaryKey="true" primaryKeyName="PK_WIKI_DRAFT_PAGES_DRAFT_PAGE_ID"/>
            </column>
            <column name="TARGET_PAGE_ID" type="BIGINT"/>
            <column name="TARGET_PAGE_REVISION" type="VARCHAR(50)"/>
            <column name="NEW_PAGE" type="CHAR(1)"/>
            <column name="AUTHOR" type="VARCHAR(36)"/>
            <column name="NAME" type="VARCHAR(50)"/>
            <column name="TITLE" type="VARCHAR(250)"/>
            <column name="CONTENT" type="TEXT(5000)"/>
            <column name="SYNTAX" type="TEXT(5000)"/>
            <column name="CREATED_DATE" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="UPDATED_DATE" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="wiki-rdbms" id="1.0.0-8">
        <addForeignKeyConstraint baseColumnNames="WIKI_HOME" baseTableName="WIKI_WIKIS"
                                 constraintName="FK_WIKI_WIKIS_WIKI_HOME" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="PAGE_ID" referencedTableName="WIKI_PAGES"/>
    </changeSet>

    <changeSet author="wiki-rdbms" id="1.0.0-9">
        <addForeignKeyConstraint baseColumnNames="WIKI_ID" baseTableName="WIKI_PAGES"
                                 constraintName="FK_WIKI_PAGES_WIKI_ID" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="WIKI_ID" referencedTableName="WIKI_WIKIS"/>
    </changeSet>

    <changeSet author="wiki-rdbms" id="1.0.0-10">
        <addForeignKeyConstraint baseColumnNames="PARENT_PAGE_ID" baseTableName="WIKI_PAGES"
                                 constraintName="FK_WIKI_PAGES_PARENT_PAGE_ID" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="PAGE_ID" referencedTableName="WIKI_PAGES"/>
    </changeSet>

    <changeSet author="wiki-rdbms" id="1.0.0-11">
        <addForeignKeyConstraint baseColumnNames="PAGE_ID" baseTableName="WIKI_WATCHERS"
                                 constraintName="FK_WIKI_WATCHERS_PAGE_ID" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="PAGE_ID" referencedTableName="WIKI_PAGES"/>
    </changeSet>

    <changeSet author="wiki-rdbms" id="1.0.0-12">
        <addForeignKeyConstraint baseColumnNames="WIKI_ID" baseTableName="WIKI_TEMPLATES"
                                 constraintName="FK_WIKI_TEMPLATES_WIKI_ID" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="WIKI_ID" referencedTableName="WIKI_WIKIS"/>
    </changeSet>

    <changeSet author="wiki-rdbms" id="1.0.0-13">
        <addForeignKeyConstraint baseColumnNames="TARGET_PAGE_ID" baseTableName="WIKI_DRAFT_PAGES"
                                 constraintName="FK_WIKI_DRAFT_PAGES_TARGET_PAGE_ID" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="PAGE_ID" referencedTableName="WIKI_PAGES"/>
    </changeSet>

    <changeSet author="wiki-rdbms" id="1.0.0-14">
        <addForeignKeyConstraint baseColumnNames="PAGE_ID" baseTableName="WIKI_ATTACHMENTS"
                                 constraintName="FK_WIKI_ATTACHMENTS_PAGE_ID" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="PAGE_ID" referencedTableName="WIKI_PAGES"/>
    </changeSet>

    <!-- TODO add UNIQUE constraint on (USERNAME, PAGE_ID) -->
</databaseChangeLog>